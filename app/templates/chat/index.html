{% extends "base.html" %}
{% import "_macros.html" as ui %}

{% block content %}
<h1 class="page-title">Encrypted Grove Chat</h1>

{% if state == "provisioning" %}
  <section class="card">
    <h2>Preparing Your Keys</h2>
    <p>The grove is automatically provisioning your encrypted chat keys. Sign out and back in if this message remains.</p>
  </section>
{% else %}
  <div class="chat-layout">
    <div class="chat-shell"
       data-chat-root
       data-state="{{ state }}"
       data-ws-path="/chat/ws"
       data-thread-ids='{{ thread_ids | tojson }}'
       data-current-thread-id="{{ current_thread_id or '' }}"
       data-max-length="{{ max_message_length }}"
       data-current-user-id="{{ current_user.id }}">
      <aside class="chat-sidebar" data-chat-sidebar>
        <div class="chat-sidebar-header">
          <div class="chat-sidebar-heading">
            <h2>Conversations</h2>
            <p class="chat-sidebar-subtitle">Reach your circle, near or far.</p>
          </div>
          <div class="chat-sidebar-header-actions">
            <button type="button" class="chat-sidebar-close" data-chat-sidebar-close aria-label="Close conversation list">Ã—</button>
            {% if state == "ready" %}
            <form action="{{ url_for('chat.lock') }}" method="post">
              <button type="submit" class="chat-action-button chat-action-button--compact" title="Lock encrypted chat">
                <span class="chat-action-icon" aria-hidden="true">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <rect x="5" y="11" width="14" height="10" rx="2" stroke="currentColor" stroke-width="1.6" fill="none" />
                    <path d="M8 11V8a4 4 0 0 1 8 0v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                    <circle cx="12" cy="16" r="1.4" fill="currentColor" />
                  </svg>
                </span>
                <span class="chat-action-label">Lock</span>
              </button>
            </form>
            {% endif %}
          </div>
        </div>

        <div class="chat-sidebar-actions">
          <details class="chat-action-card">
            <summary>
              <span class="chat-summary-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d="M5 5.5h9.5A3.5 3.5 0 0 1 18 9v0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                  <path d="M5 5.5h14a2.5 2.5 0 0 1 2.5 2.5v6a2.5 2.5 0 0 1-2.5 2.5h-5.5L9 21v-4H5A2.5 2.5 0 0 1 2.5 14V8A2.5 2.5 0 0 1 5 5.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" fill="none" />
                  <path d="M16 3.5v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                  <path d="M14 5.5h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                </svg>
              </span>
              <span>Start Direct Message</span>
            </summary>
            <form action="{{ url_for('chat.start_dm') }}" method="post" class="chat-sidebar-form">
              <label for="dm-recipient">Choose a member</label>
              <select id="dm-recipient" name="recipient_id" required>
                <option value="">Select a memberâ€¦</option>
                {% for member in active_recipients %}
                  <option value="{{ member.id }}">{{ member.username }}{% if not member.has_chat_keys %} (keys pending){% endif %}</option>
                {% endfor %}
              </select>
              <button type="submit" class="chat-action-submit">
                <span>Open conversation</span>
              </button>
            </form>
          </details>
          <details class="chat-action-card">
            <summary>
              <span class="chat-summary-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <circle cx="8" cy="9.5" r="3" stroke="currentColor" stroke-width="1.6" fill="none" />
                  <circle cx="16" cy="9.5" r="3" stroke="currentColor" stroke-width="1.6" fill="none" />
                  <path d="M3.5 17c0-1.93 1.57-3.5 3.5-3.5h1c1.93 0 3.5 1.57 3.5 3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                  <path d="M12.5 17c0-1.93 1.57-3.5 3.5-3.5h1c1.93 0 3.5 1.57 3.5 3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                  <path d="M12 6v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                  <path d="M10 8h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                </svg>
              </span>
              <span>Create Group Room</span>
            </summary>
            <form action="{{ url_for('chat.create_group') }}" method="post" class="chat-sidebar-form">
              <label for="group-name">Room name</label>
              <input id="group-name" name="name" type="text" maxlength="120" placeholder="Moonlit Council">
              <label for="group-members">Invite members</label>
              <select id="group-members" name="members" multiple size="6">
                {% for member in potential_group_members %}
                  <option value="{{ member.id }}">{{ member.username }}{% if not member.has_chat_keys %} (keys pending){% endif %}</option>
                {% endfor %}
              </select>
              <p class="form-hint">Hold Ctrl/âŒ˜ to choose several members at once.</p>
              <button type="submit" class="chat-action-submit">
                <span>Create room</span>
              </button>
            </form>
          </details>
        </div>

        <section class="chat-sidebar-section">
          <header class="chat-sidebar-section-header">
            <span>Available Now</span>
            <span class="chat-sidebar-count">{{ active_recipients|length }}</span>
          </header>
          <ul class="chat-contact-list">
            {% for member in active_recipients %}
            <li class="chat-contact">
              <form action="{{ url_for('chat.start_dm') }}" method="post" class="chat-contact-form">
                <input type="hidden" name="recipient_id" value="{{ member.id }}">
                <button type="submit" class="chat-contact-button">
                  <span class="chat-contact-name">{{ member.username }}</span>
                  <span class="chat-contact-meta">Direct message</span>
                </button>
              </form>
            </li>
            {% else %}
            <li class="chat-contact chat-contact-empty">
              <span>No members are active right now.</span>
            </li>
            {% endfor %}
          </ul>
          {% if offline_recipients %}
          <button type="button" class="chat-contact-toggle" data-chat-offline-toggle aria-expanded="false" aria-controls="chat-offline-list">
            <span data-chat-offline-toggle-label>Show offline members</span>
          </button>
          <ul class="chat-contact-list chat-contact-list--offline is-hidden" id="chat-offline-list" data-chat-offline-list>
            {% for member in offline_recipients %}
            <li class="chat-contact is-offline">
              <form action="{{ url_for('chat.start_dm') }}" method="post" class="chat-contact-form">
                <input type="hidden" name="recipient_id" value="{{ member.id }}">
                <button type="submit" class="chat-contact-button"{% if not member.has_chat_keys %} disabled{% endif %}>
                  <span class="chat-contact-name">{{ member.username }}</span>
                  <span class="chat-contact-meta">{% if member.has_chat_keys %}Offline{% else %}Keys pending{% endif %}</span>
                </button>
              </form>
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </section>

        <section class="chat-sidebar-section">
          <header class="chat-sidebar-section-header">
            <span>Direct Messages</span>
            <span class="chat-sidebar-count">{{ direct_threads|length }}</span>
          </header>
          {% if direct_threads %}
          <ul class="chat-thread-list chat-thread-rail">
            {% for entry in direct_threads %}
            <li class="chat-thread-card {% if selected_thread and entry.thread.id == selected_thread.thread.id %}active{% endif %}"
                data-thread-id="{{ entry.thread.id }}"
                data-is-group="{{ 1 if entry.is_group else 0 }}"
                data-owner-id="{{ entry.owner_id }}">
              <a href="{{ url_for('chat.index', thread=entry.thread.id) }}" class="chat-thread-link">
                <div class="chat-thread-row">
                  <span class="chat-thread-name">{{ entry.display_name }}</span>
                  {% if entry.last_at %}
                  <time datetime="{{ entry.last_at.isoformat() }}">{{ entry.last_at.strftime('%b %d %H:%M') }}</time>
                  {% endif %}
                </div>
                <p class="chat-thread-preview" data-thread-preview>{{ entry.preview or 'Say hello to restart the conversation.' }}</p>
                <span class="chat-thread-unread{% if not entry.unread_count %} is-hidden{% endif %}" data-thread-unread>
                  {% if entry.unread_count %}{{ entry.unread_count }}{% endif %}
                </span>
              </a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="chat-empty">No direct messages yet. Begin a new conversation above.</p>
          {% endif %}
        </section>

        <section class="chat-sidebar-section">
          <header class="chat-sidebar-section-header">
            <span>Group Channels</span>
            <span class="chat-sidebar-count">{{ group_threads|length }}</span>
          </header>
          {% if group_threads %}
          <ul class="chat-thread-list chat-thread-rail">
            {% for entry in group_threads %}
            <li class="chat-thread-card {% if selected_thread and entry.thread.id == selected_thread.thread.id %}active{% endif %}"
                data-thread-id="{{ entry.thread.id }}"
                data-is-group="1"
                data-owner-id="{{ entry.owner_id }}">
              <a href="{{ url_for('chat.index', thread=entry.thread.id) }}" class="chat-thread-link">
                <div class="chat-thread-row">
                  <span class="chat-thread-name">{{ entry.display_name }}</span>
                  {% if entry.last_at %}
                  <time datetime="{{ entry.last_at.isoformat() }}">{{ entry.last_at.strftime('%b %d %H:%M') }}</time>
                  {% endif %}
                </div>
                <p class="chat-thread-preview" data-thread-preview>{{ entry.preview or 'Share something with the group.' }}</p>
                <span class="chat-thread-unread{% if not entry.unread_count %} is-hidden{% endif %}" data-thread-unread>
                  {% if entry.unread_count %}{{ entry.unread_count }}{% endif %}
                </span>
              </a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="chat-empty">You havenâ€™t joined any groups yet. Create one above.</p>
          {% endif %}
        </section>
      </aside>
      <div class="chat-sidebar-overlay" data-chat-sidebar-overlay></div>

      <section class="chat-window">
        {% if state == "locked" %}
          <div class="chat-placeholder">
            <p>Enter your account password to unlock encrypted messages.</p>
            <form action="{{ url_for('chat.unlock') }}" method="post" class="stacked-form unlock-inline">
              <label for="unlock-passphrase">Account password</label>
              <input id="unlock-passphrase" type="password" name="passphrase" required autocomplete="current-password">
              <button type="submit" class="primary">Unlock</button>
            </form>
          </div>
        {% elif selected_thread %}
          <header class="chat-window-header">
            <div>
              <h2>{{ selected_thread.display_name }}</h2>
              <div class="chat-window-meta">
                {% if selected_thread.is_group %}
                  <span class="chat-room-pill">Group Channel</span>
                {% else %}
                  <span class="chat-room-pill">Direct Message</span>
                {% endif %}
                {% if selected_thread_members %}
                  <div class="chat-member-list" role="list">
                    {% for member in selected_thread_members %}
                      <div role="listitem" class="chat-member-chip">
                        {{ ui.user_chip(member, size='xs', link='message') }}
                        {% if selected_thread.is_group and selected_thread.thread.creator_id == current_user.id and member.id != current_user.id %}
                          <button type="button" class="chat-member-kick" data-kick-member data-thread-id="{{ selected_thread.thread.id }}" data-user-id="{{ member.id }}" title="Remove {{ member.username }} from group">Ã—</button>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="chat-window-controls">
              <button type="button" class="chat-sidebar-open" data-chat-sidebar-open aria-label="Show conversation list">
                <span aria-hidden="true">â˜°</span>
              </button>
              <div class="chat-window-actions">
                {% if selected_thread.is_group %}
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    {% if selected_thread.thread.creator_id == current_user.id %}
                    <button type="button" class="ghost-button chat-action-button" data-add-members data-thread-id="{{ selected_thread.thread.id }}">
                      <span class="chat-action-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                          <path d="M12 5v10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                          <path d="M7 10h10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                        </svg>
                      </span>
                      <span class="chat-action-label">Add Members</span>
                    </button>
                    <button type="button" class="ghost-button danger-button chat-action-button" data-thread-action="delete" data-thread-id="{{ selected_thread.thread.id }}">
                      <span class="chat-action-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                          <path d="M6 7h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                          <path d="M10 4h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                          <path d="M8.5 7v11a1.5 1.5 0 0 0 1.5 1.5h4a1.5 1.5 0 0 0 1.5-1.5V7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                        </svg>
                      </span>
                      <span class="chat-action-label">Delete Group</span>
                    </button>
                    {% else %}
                    <button type="button" class="ghost-button chat-action-button" data-thread-action="leave" data-thread-id="{{ selected_thread.thread.id }}">
                      <span class="chat-action-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                          <path d="M14.5 16l4-4-4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                          <path d="M4 12h14.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                        </svg>
                      </span>
                      <span class="chat-action-label">Leave Group</span>
                    </button>
                    {% endif %}
                  </div>
                {% else %}
                  {% if blocked_user_id %}
                  <button type="button" class="ghost-button chat-action-button" data-unblock-user data-user-id="{{ blocked_user_id }}">
                    <span class="chat-action-icon" aria-hidden="true">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M7 17l10-10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                        <circle cx="12" cy="12" r="7" stroke="currentColor" stroke-width="1.6" fill="none" />
                      </svg>
                    </span>
                    <span class="chat-action-label">Unblock User</span>
                  </button>
                  {% else %}
                    {% set other_user = selected_thread_members | selectattr('id', 'ne', current_user.id) | first %}
                    {% if other_user %}
                    <button type="button" class="ghost-button danger-button chat-action-button" data-block-user data-user-id="{{ other_user.id }}">
                      <span class="chat-action-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                          <circle cx="12" cy="12" r="7" stroke="currentColor" stroke-width="1.6" fill="none" />
                          <path d="M7 17l10-10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" fill="none" />
                        </svg>
                      </span>
                      <span class="chat-action-label">Block User</span>
                    </button>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </header>
          <div class="chat-window-resize-handle" data-main-chat-resize></div>
          <div class="chat-message-list" data-message-list>
            {% if messages %}
              {% for message in messages %}
              <article
                class="chat-message {% if message.is_self %}chat-message-self{% endif %}"
                data-message-id="{{ message.id }}"
              >
                <div class="chat-message-meta">
                  {% if message.is_self %}
                    {{ ui.user_chip(current_user, size='xs', link='profile', label='You') }}
                  {% else %}
                    {{ ui.user_chip(message.sender, size='xs', link='message') }}
                  {% endif %}
                  <div class="chat-message-tools">
                    <time datetime="{{ message.created_at.isoformat() }}">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</time>
                    {% if message.can_delete %}
                    <button
                      type="button"
                      class="chat-message-delete"
                      data-message-delete
                      data-thread-id="{{ selected_thread.thread.id }}"
                      data-message-id="{{ message.id }}"
                      data-is-group="{{ 1 if selected_thread.is_group else 0 }}"
                      aria-label="Delete message"
                    >Ã—</button>
                    {% endif %}
                  </div>
                </div>
                <div class="chat-message-body">{{ message.body }}</div>
              </article>
              {% endfor %}
            {% else %}
            <p class="muted">This encrypted channel is ready for its first words.</p>
            {% endif %}
          </div>
          <form action="{{ url_for('chat.send') }}" method="post" class="chat-compose" data-compose-form>
            <input type="hidden" name="thread_id" value="{{ selected_thread.thread.id }}">
            <label for="chat-body" class="sr-only">Message body</label>
            <textarea id="chat-body" name="body" rows="3" maxlength="{{ max_message_length|default(4000) }}" required placeholder="Type your encrypted messageâ€¦"></textarea>
            <div class="chat-compose-actions">
              <button type="button" class="chat-icon-btn emoji-picker-btn" data-emoji-picker-btn title="Add emoji">
                <span class="emoji-icon">ðŸ˜Š</span>
              </button>
              <button type="button" class="chat-icon-btn gif-picker-btn" data-gif-picker-btn title="Add GIF">
                <span class="gif-icon">ðŸŽ¬</span>
              </button>
              <button type="submit" class="btn btn-primary chat-send-btn">Send Encrypted Message</button>
            </div>
          </form>

          <!-- Emoji Picker Modal (inside chat window) -->
          <div class="emoji-picker-modal in-chat" data-emoji-picker-modal style="display: none;">
            <div class="emoji-picker-overlay" data-emoji-picker-overlay></div>
            <div class="emoji-picker-content">
              <div class="emoji-picker-header">
                <h3>Pick an Emoji</h3>
                <input type="text" class="emoji-search-input" placeholder="Search emojis..." data-emoji-search-input>
                <button type="button" class="emoji-picker-close" data-emoji-picker-close>Ã—</button>
              </div>
              <div class="emoji-picker-grid" data-emoji-grid></div>
            </div>
          </div>

          <!-- GIPHY Picker Modal (inside chat window) -->
          <div class="gif-picker-modal in-chat" data-gif-picker-modal style="display: none;">
            <div class="gif-picker-overlay" data-gif-picker-overlay></div>
            <div class="gif-picker-content">
              <div class="gif-picker-header">
                <input type="text" class="gif-search-input" placeholder="Search GIPHY..." data-gif-search-input>
                <button type="button" class="gif-picker-close" data-gif-picker-close>Ã—</button>
              </div>
              <div class="gif-picker-results" data-gif-results></div>
            </div>
          </div>

          <!-- Add Members Modal (inside chat window) -->
          {% if selected_thread.is_group and selected_thread.thread.creator_id == current_user.id %}
          <div class="add-members-modal" data-add-members-modal style="display: none;">
            <div class="add-members-overlay" data-add-members-overlay></div>
            <div class="add-members-content">
              <div class="add-members-header">
                <h3>Add Members to Group</h3>
                <button type="button" class="add-members-close" data-add-members-close>Ã—</button>
              </div>
              <div class="add-members-body">
                <input type="text" class="add-members-search" placeholder="Search users..." data-add-members-search>
                <div class="add-members-results" data-add-members-results></div>
              </div>
            </div>
          </div>
          {% endif %}
        {% else %}
          <div class="chat-placeholder">
            <p>Select or create a channel to begin an encrypted conversation.</p>
            <button type="button" class="chat-sidebar-open" data-chat-sidebar-open aria-label="Show conversation list on mobile">
              <span aria-hidden="true">â˜°</span>
              <span class="sr-only">Open conversations</span>
            </button>
          </div>
        {% endif %}
      </section>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if state == "ready" or state == "locked" %}
<script src="{{ url_for('static', filename='js/emoji_picker.js') }}?v=1761507823"></script>
<script src="{{ url_for('static', filename='js/giphy.js') }}?v=1761507823"></script>
{% endif %}
{% endblock %}
