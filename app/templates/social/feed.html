{% extends "base.html" %}
{% block content %}
<section class="grid">
  <div class="primary-column">
    <article class="card neod-callout">
      <header class="neod-callout-header">
        <h2>Support the NEOD Grove</h2>
        <p>Offer 0.005&nbsp;SOL to the treasury and receive 1&nbsp;NEOD to anchor the distributed network.</p>
      </header>
      <a class="pill pill-accent neod-callout-button" href="{{ url_for('neod.donate') }}">
        Donate 0.005&nbsp;SOL for NEOD
      </a>
    </article>
    <article class="card">
      <h2>Offer to the Stream</h2>
      <form method="post" action="{{ url_for('social.create_post') }}" class="form">
        <label>
          Words for the circle
          <textarea name="body" rows="4" required></textarea>
        </label>
        
        <button type="submit" class="button">Share</button>
      </form>
    </article>

    {% for entry in post_entries %}
    {% set post = entry.record %}
    <article class="card">
      <header class="post-header">
        <div class="post-author">
          <a href="{{ url_for('social.profile', username=post.author.username) }}" class="avatar-link">
            {% if post.author.profile_image %}
            <img src="{{ url_for('social.profile_media', asset=post.author.profile_image) }}" alt="{{ post.author.username }} avatar" class="avatar avatar-sm">
            {% else %}
            <img src="{{ url_for('static', filename='img/triple.svg.png') }}" alt="{{ post.author.username }} avatar" class="avatar avatar-sm">
            {% endif %}
          </a>
          <div class="post-author-meta">
            <h3><a href="{{ url_for('social.profile', username=post.author.username) }}">{{ post.author.username }}</a></h3>
            <p class="meta">{{ post.created_at.strftime('%b %d, %Y %H:%M') }}</p>
          </div>
        </div>
        <div class="post-header-actions">
          {% if post.ritual_focus %}
          <span class="tag">{{ post.ritual_focus }}</span>
          {% endif %}
          {% if current_user.is_authenticated and current_user.is_arch %}
          <form method="post" action="{{ url_for('arch.remove_post', post_id=post.id) }}" class="inline-form moderation-form">
            <button type="submit" class="ghost-button danger-button">Remove</button>
          </form>
          {% endif %}
        </div>
      </header>
      <div class="post-body">{{ entry.body_html }}</div>
      {% if entry.preview %}
      <a href="{{ entry.preview.url }}" target="_blank" rel="noopener" class="link-preview">
        {% if entry.preview.image %}
        <div class="link-preview-thumb" style="background-image: url('{{ entry.preview.image }}');"></div>
        {% endif %}
        <div class="link-preview-body">
          <p class="link-preview-title">{{ entry.preview.title }}</p>
          {% if entry.preview.description %}
          <p class="link-preview-desc">{{ entry.preview.description }}</p>
          {% endif %}
          <span class="link-preview-domain">{{ entry.preview.domain }}</span>
        </div>
      </a>
      {% endif %}
      <section class="comments">
        <h4>Responses</h4>
        {% for comment in post.comments %}
        <div class="comment">
          <strong>{{ comment.author.username }}</strong>
          <p>{{ comment.body }}</p>
          <span class="meta">{{ comment.created_at.strftime('%b %d, %Y %H:%M') }}</span>
          {% if current_user.is_authenticated and current_user.is_arch %}
          <form method="post" action="{{ url_for('arch.remove_comment', comment_id=comment.id) }}" class="inline-form moderation-form">
            <button type="submit" class="ghost-button danger-button">Remove</button>
          </form>
          {% endif %}
        </div>
        {% else %}
        <p class="meta">No responses yet.</p>
        {% endfor %}
        <form method="post" action="{{ url_for('social.comment', post_id=post.id) }}" class="comment-form">
          <textarea name="body" rows="2" required placeholder="Offer a reflection..."></textarea>
          <button type="submit" class="ghost-button">Add response</button>
        </form>
      </section>
    </article>
    {% else %}
    <p>The stream is quiet. Be the first to speak.</p>
    {% endfor %}
  </div>

  <aside class="sidebar">
    <section class="card">
      <h2>Circle Filter</h2>
      <form method="get" action="{{ url_for('social.feed') }}" class="form">
        <label>
          Circle
          <select name="circle">
            <option value="">All One Circle</option>
            {% for circle in circles %}
            <option value="{{ circle.name }}" {% if request.args.get('circle') == circle.name %}selected{% endif %}>
              {{ circle.name }}
            </option>
            {% endfor %}
          </select>
        </label>
        <button type="submit" class="ghost-button">Apply</button>
      </form>
    </section>

    <section class="card archdruid-card">
      <div class="archdruid-heading">
        <div>
          <h2>Archdruid</h2>
        </div>
        <span class="archdruid-pulse" aria-hidden="true"></span>
      </div>
      <form id="insight-form" class="form archdruid-form" novalidate>
        <label class="archdruid-prompt">
          Question for the grove
          <textarea name="prompt" rows="3" required placeholder="Suggest a solstice ritual..."></textarea>
        </label>
        <button type="submit" class="button archdruid-button" data-state="idle">
          <span class="button-label">Ask the Grove</span>
          <span class="button-spinner" aria-hidden="true"></span>
        </button>
      </form>
      <div id="insight-output" class="insight-output hidden" role="status" aria-live="polite"></div>
    </section>
  </aside>
</section>
{% endblock %}
