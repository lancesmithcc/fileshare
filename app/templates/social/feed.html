{% extends "base.html" %}
{% import "_macros.html" as ui %}
{% block content %}
<section class="grid stream-grid">
  <div class="primary-column">
    <header class="stream-header">
      <h1 class="stream-title">The Stream</h1>
      <p class="stream-subtitle">Share reflections with the grove.</p>
    </header>

    <article class="card stream-compose">
      <h2>Offer to the Stream</h2>
      <form method="post" action="{{ url_for('social.create_post') }}" class="form stream-compose-form">
        <label>
          Words for the circle
          <textarea name="body" rows="4" required placeholder="Speak into the flowâ€¦"></textarea>
        </label>
        <button type="submit" class="button">Share</button>
      </form>
    </article>

    {% for entry in post_entries %}
    {% set post = entry.record %}
    <article class="card stream-post">
      <header class="post-header">
        <div class="post-author">
          {{ ui.user_chip(post.author, size='md') }}
          <div class="post-author-meta">
            <p class="meta">{{ post.created_at.strftime('%b %d, %Y %H:%M') }} UTC</p>
          </div>
        </div>
        <div class="post-header-actions">
          {% if post.ritual_focus %}
          <span class="tag">{{ post.ritual_focus }}</span>
          {% endif %}
          {% if current_user.is_authenticated and current_user.is_arch %}
          <form method="post" action="{{ url_for('arch.remove_post', post_id=post.id) }}" class="inline-form moderation-form">
            <button type="submit" class="ghost-button danger-button">Remove</button>
          </form>
          {% endif %}
        </div>
      </header>
      <div class="post-body">{{ entry.body_html }}</div>
      {% if entry.preview %}
      <a href="{{ entry.preview.url }}" target="_blank" rel="noopener" class="link-preview">
        {% if entry.preview.image %}
        <div class="link-preview-thumb" style="background-image: url('{{ entry.preview.image }}');"></div>
        {% endif %}
        <div class="link-preview-body">
          <p class="link-preview-title">{{ entry.preview.title }}</p>
          {% if entry.preview.description %}
          <p class="link-preview-desc">{{ entry.preview.description }}</p>
          {% endif %}
          <span class="link-preview-domain">{{ entry.preview.domain }}</span>
        </div>
      </a>
      {% endif %}
      <section class="comments">
        <header class="comments-header">
          <h4>Responses</h4>
          <span class="comments-count">{{ post.comments|length }}</span>
        </header>
        <div class="comments-list">
          {% for comment in post.comments %}
          <article class="comment">
            {{ ui.user_chip(comment.author, size='sm') }}
            <div class="comment-body">
              <div class="comment-meta">
                <time datetime="{{ comment.created_at.isoformat() }}">{{ comment.created_at.strftime('%b %d, %Y %H:%M') }} UTC</time>
              </div>
              <p>{{ comment.body }}</p>
              {% if current_user.is_authenticated and current_user.is_arch %}
              <form method="post" action="{{ url_for('arch.remove_comment', comment_id=comment.id) }}" class="inline-form moderation-form comment-moderation">
                <button type="submit" class="ghost-button danger-button">Remove</button>
              </form>
              {% endif %}
            </div>
          </article>
          {% else %}
          <p class="meta comments-empty">No responses yet.</p>
          {% endfor %}
        </div>
        <form method="post" action="{{ url_for('social.comment', post_id=post.id) }}" class="comment-form">
          <span class="comment-form-spacer" aria-hidden="true"></span>
          <textarea name="body" rows="2" required placeholder="Offer a reflection..."></textarea>
          <div class="comment-form-actions">
            <button type="submit" class="ghost-button comment-submit">Add response</button>
          </div>
        </form>
      </section>
    </article>
    {% else %}
    <p>The stream is quiet. Be the first to speak.</p>
    {% endfor %}
  </div>

  <aside class="sidebar">
    
    <section class="card">
      <h2>Circle Filter</h2>
      <form method="get" action="{{ url_for('social.feed') }}" class="form">
        <label>
          Circle
          <select name="circle">
            <option value="">All One Circle</option>
            {% for circle in circles %}
            <option value="{{ circle.name }}" {% if request.args.get('circle') == circle.name %}selected{% endif %}>
              {{ circle.name }}
            </option>
            {% endfor %}
          </select>
        </label>
        <button type="submit" class="ghost-button">Apply</button>
      </form>
    </section>

    <section class="card archdruid-card">
      <div class="archdruid-heading">
        <div>
          <h2>Archdruid</h2>
        </div>
        <span class="archdruid-pulse" aria-hidden="true"></span>
      </div>
      <form id="insight-form" class="form archdruid-form" novalidate>
        <label class="archdruid-prompt">
          Question for the grove
          <textarea name="prompt" rows="3" required placeholder="Suggest a solstice ritual..."></textarea>
        </label>
        <button type="submit" class="button archdruid-button" data-state="idle">
          <span class="button-label">Ask the Grove</span>
          <span class="button-spinner" aria-hidden="true"></span>
        </button>
      </form>
      <div id="insight-output" class="insight-output hidden" role="status" aria-live="polite"></div>
    </section>
    <article class="card neod-callout">
      <header class="neod-callout-header">
        <h2>Support</h2>
        <p>Offer 0.005&nbsp;SOL to the treasury and receive 1&nbsp;NEOD to anchor the distributed network.</p>
      </header>
      <a class="pill pill-accent neod-callout-button" href="{{ url_for('neod.donate') }}">
        Donate 0.005&nbsp;SOL for NEOD
      </a>
    </article>
  </aside>
</section>
{% endblock %}
